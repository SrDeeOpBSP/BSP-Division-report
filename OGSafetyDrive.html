<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REGULAR AND ONGOING SAFETY DRIVE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
    /* === PAGE BACKGROUND === */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #a1c4fd 20%, #c2e9fb 60%, #f6cfbe 100%);
        background-attachment: fixed;
        color: #333;
        padding: 20px;
        line-height: 1.6;
    }

    h2 { text-align: center; color: #2c3e50; margin-bottom: 30px; }

    /* === FORM STYLING === */
    form {
        max-width: 800px;
        margin: auto;
        padding: 30px;
        background-color: rgba(255, 255, 255, 0.85); 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 15px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    }

    label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: 600;
        color: #34495e;
    }

    input[type="text"], input[type="date"], select, textarea {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        box-sizing: border-box;
        border: 1px solid #ced4da;
        border-radius: 8px;
        background-color: #ffffff;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    input:focus, select:focus, textarea:focus {
        border-color: #007BFF;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        outline: none;
    }

    /* === DRIVE SECTION STYLING === */
    .drive-section {
        border: 1px solid #e9ecef;
        padding: 20px;
        margin-top: 20px;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.5);
    }

    .location-label, .remark-label, .abnormality-label {
         margin-top: 15px !important; 
         font-weight: normal !important;
         color: #555;
    }
    
    .char-limit-message { color: #d9534f; font-size: 0.85em; margin-top: 5px; height: 15px; }

    /* === ACTION TAKEN SECTION === */
    .action-taken-container {
        margin-top: 15px;
        padding: 15px;
        border: 1px dashed #007BFF;
        border-radius: 8px;
        background-color: rgba(0, 123, 255, 0.05);
        display: none; 
    }

    .checkbox-group {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 5px;
    }

    /* === BUTTONS === */
    button {
        background: linear-gradient(45deg, #007BFF, #0056b3);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin-top: 20px;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
    }
    button:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3); }
    button:disabled { background: linear-gradient(45deg, #ff9d2f, #ff6b00); cursor: not-allowed; transform: none; }

    /* === TABLE STYLES (Vertical Stack with Placeholder for Empty PDF) === */
    .ongoing-drive-table {
        display: grid; 
        grid-template-columns: 3fr 1fr; 
        gap: 15px; 
        margin-top: 10px; 
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.5); 
        border: 1px solid #e9ecef; 
        border-radius: 8px;
    }
    .table-header { 
        grid-column: 1 / -1; 
        display: grid; 
        grid-template-columns: 3fr 1fr; 
        gap: 15px; 
        padding-bottom: 10px; 
        border-bottom: 2px solid #ced4da; 
        font-weight: bold; 
        color: #2c3e50; 
    }
    .table-cell { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    .drive-link-button, .pdf-link-button {
        width: 100%; 
        padding: 12px; 
        text-align: center; 
        text-decoration: none; 
        color: white; 
        border-radius: 8px; 
        font-weight: bold; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        min-height: 60px;
    }
    .drive-link-button { background: linear-gradient(45deg, #28a745, #218838); }
    .pdf-link-button { background: linear-gradient(45deg, #fd7e14, #ffc107); }
    .empty-pdf { background-color: transparent; border: 1px dashed #ccc; width: 100%; min-height: 60px; border-radius: 8px; }

    </style>
</head>
<body>
    <h2 style="text-align: center;">REGULAR AND ONGOING SAFETY DRIVE</h2>

    <form id="safetyDriveForm">
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required><br><br>

        <label for="cli_id">CLI ID:</label>
        <input type="text" id="cli_id" name="cli_id" required placeholder="Example: BSP0068" oninput="formatCLIID()" maxlength="10">
        
        <label for="cli_name">CLI Name:</label>
        <input type="text" id="cli_name" name="cli_name" readonly>
        
        <label for="cli_hq">CLI HQ:</label>
        <input type="text" id="cli_hq" name="cli_hq" readonly><br><br>

        <label>REGULAR DRIVE (Enter details for each drive):</label>

        <div class="drive-section">
            <label for="crew_ids_yy_y">Counselling on Maximum speed for YY and Y aspect of Signal (Railway Board letter No 2024/Elect(TRS)/113/10)</label>
            <input type="text" id="crew_ids_yy_y" class="crew-input" data-drive-name="Counselling on Maximum speed for YY and Y aspect of Signal (Railway Board letter No 2024/Elect(TRS)/113/10)" placeholder="Enter Crew IDs, separated by comma..." oninput="formatCrewIDs(this)">
            <p class="char-limit-message"></p>
            
            <label class="location-label">Counselling Done at:</label>
            <select class="location-select">
                <option value="">Select Location</option>
                <option value="LOBBY">LOBBY</option>
                <option value="FOOTPLATE">FOOTPLATE</option>
            </select>

            <label class="abnormality-label">Abnormalities Found on this drive:</label>
            <input type="text" class="abnormality-input" value="NIL" oninput="checkAbnormalities(this)">

            <div class="action-taken-container">
                <label style="margin-top:0;">Action Taken:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" class="action-cms"> Reported in CMS</label>
                    <label><input type="checkbox" class="action-other" onchange="toggleOtherText(this)"> Other</label>
                </div>
                <input type="text" class="action-other-text" placeholder="Please specify other action taken..." style="display:none;">
            </div>

            <label class="remark-label">Remark for this drive:</label>
            <textarea class="remark-input" rows="3" placeholder="Enter remarks"></textarea>
        </div>

        <div class="drive-section">
            <label for="crew_ids_spad">RAILWAY BOARD SAFETY DRIVE COUNSELLING ON SPAD</label>
            <input type="text" id="crew_ids_spad" class="crew-input" data-drive-name="RAILWAY BOARD SAFETY DRIVE COUNSELLING ON SPAD" placeholder="Enter Crew IDs, separated by comma..." oninput="formatCrewIDs(this)">
            <p class="char-limit-message"></p>
            
            <label class="location-label">Counselling Done at:</label>
            <select class="location-select">
                <option value="">Select Location</option>
                <option value="LOBBY">LOBBY</option>
                <option value="FOOTPLATE">FOOTPLATE</option>
            </select>

            <label class="abnormality-label">Abnormalities Found on this drive:</label>
            <input type="text" class="abnormality-input" value="NIL" oninput="checkAbnormalities(this)">

            <div class="action-taken-container">
                <label style="margin-top:0;">Action Taken:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" class="action-cms"> Reported in CMS</label>
                    <label><input type="checkbox" class="action-other" onchange="toggleOtherText(this)"> Other</label>
                </div>
                <input type="text" class="action-other-text" placeholder="Please specify other action taken..." style="display:none;">
            </div>

            <label class="remark-label">Remark for this drive:</label>
            <textarea class="remark-input" rows="3" placeholder="Enter remarks"></textarea>
        </div>

        <div class="drive-section">
            <label for="crew_ids_winter">WINTER AND FOG PRECAUTION SAFETY DRIVE</label>
            <input type="text" id="crew_ids_winter" class="crew-input" data-drive-name="WINTER AND FOG PRECAUTION SAFETY DRIVE" placeholder="Enter Crew IDs, separated by comma..." oninput="formatCrewIDs(this)">
            <p class="char-limit-message"></p>
                
            <label class="location-label">Counselling Done at:</label>
            <select class="location-select">
                <option value="">Select Location</option>
                <option value="LOBBY">LOBBY</option>
                <option value="FOOTPLATE">FOOTPLATE</option>
            </select>

            <label class="abnormality-label">Abnormalities Found on this drive:</label>
            <input type="text" class="abnormality-input" value="NIL" oninput="checkAbnormalities(this)">

            <div class="action-taken-container">
                <label style="margin-top:0;">Action Taken:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" class="action-cms"> Reported in CMS</label>
                    <label><input type="checkbox" class="action-other" onchange="toggleOtherText(this)"> Other</label>
                </div>
                <input type="text" class="action-other-text" placeholder="Please specify other action taken..." style="display:none;">
            </div>

            <label class="remark-label">Remark for this drive:</label>
            <textarea class="remark-input" rows="3" placeholder="Enter remarks"></textarea>
        </div>

        <div class="drive-section">
            <label for="crew_ids_rs_valve">Practical RS Application during Footplate</label>
            <input type="text" id="crew_ids_rs_valve" class="crew-input" data-drive-name="Practical RS Application during Footplate" placeholder="Enter Crew IDs, separated by comma..." oninput="formatCrewIDs(this)">
            <p class="char-limit-message"></p>
            
            <label class="location-label">Practical RS Application done at :</label>
            <input type="text" class="location-input" placeholder="Enter Location">
        </div>
        
        <br>
        <label>ONGOING SAFETY DRIVE:</label>
        <div class="ongoing-drive-table">
            <div class="table-header">
                <div>Drive / Google Link</div>
                <div>Download PDF</div>
            </div>

            <div class="table-cell">
                <a href="https://docs.google.com/spreadsheets/d/1AzJEp0--ScREpzMMvUT9lO3RkdhUoyvJT2BZWAG_WgA/edit?gid=0#gid=0" target="_blank" class="drive-link-button">(RS PRACTICE ON RUN DETAILS)</a>
            </div>
            <div class="table-cell">
                <div class="empty-pdf"></div> </div>

            <div class="table-cell">
                <a href="https://docs.google.com/spreadsheets/d/1IqgKKpbLgGdkmC6eXgvtUFCxhLkIU0kgyVBgt0zadnM/edit?gid=0#gid=0" target="_blank" class="drive-link-button">(RS PRACTICE DATE ENTRY FOR ALPS )</a>
            </div>
            <div class="table-cell">
                <div class="empty-pdf"></div> </div>

            <div class="table-cell">
                <a href="https://docs.google.com/spreadsheets/d/1sh45QJ75aFe07CRbHTJ-muTuw2ZCXCfcRM_jMxo_ezA/edit?usp=sharing" target="_blank" class="drive-link-button">Drive No. 22 (FY 2025-26): 30 days Intra Railway Audit inspection of Lobbies and Running room.((16-01-2026 to 14-02-2026))</a>
            </div>
            <div class="table-cell">
                <a href="https://drive.google.com/file/d/1I8ZhWbtn2D20z2SYfseC07o3T6UaSSJS/view?usp=sharing" target="_blank" class="pdf-link-button">View PDF</a> 
            </div>
            <div class="table-cell">
                <a href="https://docs.google.com/spreadsheets/d/1yjvTMiaGci2iZFEONWfmsTw5ar2IfBzboNBPGpCO2YE/edit?usp=sharing" target="_blank" class="drive-link-button">Zonal Safety Drive on Precaution during Loading Unloading from 04.02.2026-18.02.2026</a>
            </div>
            <div class="table-cell">
                <a href="https://drive.google.com/file/d/1S3e2DJHhbwk6hd99UiBjFAJmMEobxHti/view?usp=sharing" target="_blank" class="pdf-link-button">View PDF</a> 
            </div>
            <div class="table-cell">
                <a href="https://docs.google.com/spreadsheets/d/1P7L6r8WEOnoSbbiRkexWKRe_RRxC12WQ6kVYMYCnwoQ/edit?usp=sharing" target="_blank" class="drive-link-button">ROLL DOWN PREVENTION COUNSELLING</a>
            </div>
            <div class="table-cell">
                <a href="https://drive.google.com/file/d/1oGpq80Df0c6v-kTpGkSuZKYNwrNsUDem/view?usp=sharing" target="_blank" class="pdf-link-button">View PDF</a> 
            </div>
             <div class="table-cell">
                <a href="https://docs.google.com/spreadsheets/d/1fKkAdjW26ajjutnxKFCex5Hi-MlVa2b3uXjJe-NoNws/edit?usp=sharing" target="_blank" class="drive-link-button">(CRB INSTRUCTION: ALP to call out "Approaching Danger" after passing Y aspect till next signal is clearly visible.)</a>
            </div>
            <div class="table-cell">
                <div class="empty-pdf"></div> </div>
        </div>
        <br><br>

        <button type="submit">SUBMIT</button>
    </form>

<script>
    let cliData = {};
    let crewData = {};
    let isSubmitting = false;

    function checkAbnormalities(inputElement) {
        const driveSection = inputElement.closest('.drive-section');
        const actionContainer = driveSection.querySelector('.action-taken-container');
        if (!actionContainer) return;
        if (inputElement.value.trim().toUpperCase() !== 'NIL') {
            actionContainer.style.display = 'block';
        } else {
            actionContainer.style.display = 'none';
            driveSection.querySelector('.action-cms').checked = false;
            driveSection.querySelector('.action-other').checked = false;
            driveSection.querySelector('.action-other-text').style.display = 'none';
            driveSection.querySelector('.action-other-text').value = '';
        }
    }

    function toggleOtherText(checkbox) {
        const driveSection = checkbox.closest('.drive-section');
        const otherTextInput = driveSection.querySelector('.action-other-text');
        otherTextInput.style.display = checkbox.checked ? 'block' : 'none';
        if (!checkbox.checked) otherTextInput.value = '';
    }

    function formatCLIID() {
        let input = document.getElementById("cli_id");
        input.value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        fetchCLIData();
    }
    
    function formatCrewIDs(inputElement) {
        const messageElement = inputElement.nextElementSibling;
        let value = inputElement.value.toUpperCase().replace(/[^A-Z0-9,]/g, '');
        let ids = value.split(',');
        let lastIdSegment = ids[ids.length - 1];
        let message = '';

        if (lastIdSegment.length > 8) {
            message = 'Please Enter Comma.';
            lastIdSegment = lastIdSegment.substring(0, 8);
            ids[ids.length - 1] = lastIdSegment;
            value = ids.join(',');
        } else {
            const letterCount = (lastIdSegment.match(/[A-Z]/g) || []).length;
            const numberCount = (lastIdSegment.match(/[0-9]/g) || []).length;
            if (letterCount > 4 || numberCount > 4) {
                message = 'Invalid combination (max 4 letters/numbers).';
                lastIdSegment = lastIdSegment.slice(0, -1);
                ids[ids.length - 1] = lastIdSegment;
                value = ids.join(',');
            }
        }
        if (messageElement) messageElement.textContent = message;
        inputElement.value = value;
    }

    function loadCLIData() {
        fetch('CLIMICRO.csv').then(r => r.text()).then(data => {
            Papa.parse(data, { header: true, skipEmptyLines: true, complete: r => {
                r.data.forEach(row => cliData[row["LI ID"]] = { name: row["NAME"], hq: row["HQ"] });
            }});
        });
    }

    function loadCrewData() {
        fetch('CREWM.csv').then(r => r.text()).then(data => {
            Papa.parse(data, { header: true, skipEmptyLines: true, complete: r => {
                r.data.forEach(row => crewData[row["CREW ID"]] = { name: row["CREW NAME"], desg: row["DESG"], hq: row["HQ"] });
            }});
        });
    }

    function fetchCLIData() {
        let cliID = document.getElementById("cli_id").value;
        document.getElementById("cli_name").value = cliData[cliID] ? cliData[cliID].name : "";
        document.getElementById("cli_hq").value = cliData[cliID] ? cliData[cliID].hq : "";
    }

    document.getElementById("safetyDriveForm").addEventListener("submit", function(event) {
        event.preventDefault();
        if (isSubmitting) return;

        let crewInputs = document.querySelectorAll('.crew-input');
        let totalCrewEntered = 0;
        let validationError = false;

        crewInputs.forEach(input => {
            if (validationError) return;
            const val = input.value.trim();
            if (val !== "") {
                totalCrewEntered++;
                const section = input.closest('.drive-section');
                const loc = section.querySelector('.location-select') || section.querySelector('.location-input');
                if (!loc || loc.value.trim() === "") {
                    validationError = true;
                    alert("Please enter/select a location.");
                }
            }
        });

        if (validationError || totalCrewEntered === 0) {
            if(totalCrewEntered === 0) alert("Please enter at least one Crew ID.");
            return;
        }
        
        isSubmitting = true;
        let btn = document.querySelector("button[type='submit']");
        btn.disabled = true; btn.innerText = "Submitting...";

        let commonFormData = new FormData(this);
        let promises = [];
        
        crewInputs.forEach(inputField => {
            let crewIDsString = inputField.value.trim();
            if (crewIDsString === "") return;
            const section = inputField.closest('.drive-section');
            const locVal = (section.querySelector('.location-select') || section.querySelector('.location-input')).value;
            const remVal = section.querySelector('.remark-input') ? section.querySelector('.remark-input').value : "";
            const abnVal = section.querySelector('.abnormality-input') ? section.querySelector('.abnormality-input').value : "NIL";

            let actStr = "";
            if (abnVal.toUpperCase() !== 'NIL') {
                let actions = [];
                if (section.querySelector('.action-cms')?.checked) actions.push("Reported in CMS");
                if (section.querySelector('.action-other')?.checked) actions.push("Other: " + section.querySelector('.action-other-text').value);
                actStr = actions.join(', ');
            }

            crewIDsString.split(',').filter(id => id.trim() !== "").forEach(crewID => {
                crewID = crewID.trim();
                let jsonData = {
                    date: commonFormData.get('date'),
                    cli_id: commonFormData.get('cli_id'),
                    cli_name: commonFormData.get('cli_name'),
                    cli_hq: commonFormData.get('cli_hq'),
                    drive_name: inputField.dataset.driveName,
                    counselling_location: locVal,
                    remark: remVal,
                    abnormalities: abnVal,
                    action_taken: actStr,
                    crew_id: crewID,
                    crew_name: crewData[crewID] ? crewData[crewID].name : "Not Found",
                    desg: crewData[crewID] ? crewData[crewID].desg : "N/A",
                    hq: crewData[crewID] ? crewData[crewID].hq : "N/A",
                    timestamp: new Date().toISOString()
                };

                promises.push(fetch("https://script.google.com/macros/s/AKfycbz7VLDi96OQTKCbrveBmauU3mTJSFYyydtlx67qFoO0dPUwI5KU-60HaJGoHwmKlhx-kw/exec", {
                    method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(jsonData)
                }));
            });
        });

        Promise.all(promises).then(() => {
             setTimeout(() => {
                 alert("Data Successfully Submitted!");
                 location.reload();
             }, 500);
        });
    });

    window.onload = function() {
        loadCLIData();
        loadCrewData();
        document.getElementById('date').valueAsDate = new Date();
    };
</script>
</body>
</html>


