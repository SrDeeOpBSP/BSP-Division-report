<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REGULAR AND ONGOING SAFETY DRIVE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
    /* === PAGE BACKGROUND === */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #a1c4fd 20%, #c2e9fb 60%, #f6cfbe 100%);
        background-attachment: fixed;
        color: #333;
        padding: 20px;
        line-height: 1.6;
    }

    h2 { text-align: center; color: #2c3e50; margin-bottom: 30px; }

    /* === FORM STYLING === */
    form {
        max-width: 800px;
        margin: auto;
        padding: 30px;
        background-color: rgba(255, 255, 255, 0.85); 
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 15px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    }

    label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: 600;
        color: #34495e;
    }

    input[type="text"], input[type="date"], select, textarea {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        box-sizing: border-box;
        border: 1px solid #ced4da;
        border-radius: 8px;
        background-color: #ffffff;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    input:focus, select:focus, textarea:focus {
        border-color: #007BFF;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        outline: none;
    }

    /* === DRIVE SECTION STYLING === */
    .drive-section {
        border: 1px solid #e9ecef;
        padding: 20px;
        margin-top: 20px;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.5);
    }

    .location-label, .remark-label, .abnormality-label {
         margin-top: 15px !important; 
         font-weight: normal !important;
         color: #555;
    }
    
    .char-limit-message { color: #d9534f; font-size: 0.85em; margin-top: 5px; height: 15px; }

    /* === ACTION TAKEN SECTION === */
    .action-taken-container {
        margin-top: 15px;
        padding: 15px;
        border: 1px dashed #007BFF;
        border-radius: 8px;
        background-color: rgba(0, 123, 255, 0.05);
        display: none; /* Hidden by default */
    }

    .checkbox-group {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 5px;
    }

    /* === BUTTONS === */
    button {
        background: linear-gradient(45deg, #007BFF, #0056b3);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin-top: 20px;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
    }
    button:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3); }
    button:disabled { background: linear-gradient(45deg, #ff9d2f, #ff6b00); cursor: not-allowed; transform: none; }

    /* === TABLE STYLES === */
    .ongoing-drive-table {
        display: grid; grid-template-columns: 3fr 1fr; gap: 15px; margin-top: 10px; padding: 20px;
        background-color: rgba(255, 255, 255, 0.5); border: 1px solid #e9ecef; border-radius: 8px;
    }
    .table-header { grid-column: 1 / -1; display: grid; grid-template-columns: 3fr 1fr; gap: 15px; padding-bottom: 10px; border-bottom: 2px solid #ced4da; font-weight: bold; color: #2c3e50; }
    .table-cell { display: flex; align-items: center; justify-content: center; }
    .drive-link-button, .pdf-link-button {
        width: 100%; padding: 12px; text-align: center; text-decoration: none; color: white; border-radius: 8px; font-weight: bold; display: flex; align-items: center; justify-content: center; min-height: 60px;
    }
    .drive-link-button { background: linear-gradient(45deg, #28a745, #218838); }
    .pdf-link-button { background: linear-gradient(45deg, #fd7e14, #ffc107); }
    </style>
</head>
<body>
    <h2 style="text-align: center;">REGULAR AND ONGOING SAFETY DRIVE</h2>

    <form id="safetyDriveForm">
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required><br><br>

        <label for="cli_id">CLI ID:</label>
        <input type="text" id="cli_id" name="cli_id" required placeholder="Example: BSP0068" oninput="formatCLIID()" maxlength="10">
        
        <label for="cli_name">CLI Name:</label>
        <input type="text" id="cli_name" name="cli_name" readonly>
        
        <label for="cli_hq">CLI HQ:</label>
        <input type="text" id="cli_hq" name="cli_hq" readonly><br><br>

        <label>REGULAR DRIVE (Enter details for each drive):</label>

        <div class="drive-section">
            <label for="crew_ids_yy_y">Counselling on Maximum speed for YY and Y aspect of Signal (Railway Board letter No 2024/Elect(TRS)/113/10)</label>
            <input type="text" id="crew_ids_yy_y" class="crew-input" data-drive-name="Counselling on Maximum speed for YY and Y aspect of Signal (Railway Board letter No 2024/Elect(TRS)/113/10)" placeholder="Enter Crew IDs, separated by comma..." oninput="formatCrewIDs(this)">
            <p class="char-limit-message"></p>
            
            <label class="location-label">Counselling Done at:</label>
            <select class="location-select">
                <option value="">Select Location</option>
                <option value="LOBBY">LOBBY</option>
                <option value="FOOTPLATE">FOOTPLATE</option>
            </select>

            <label class="abnormality-label">Abnormalities Found on this drive:</label>
            <input type="text" class="abnormality-input" value="NIL" oninput="checkAbnormalities(this)">

            <div class="action-taken-container">
                <label style="margin-top:0;">Action Taken:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" class="action-cms"> Reported in CMS</label>
                    <label><input type="checkbox" class="action-other" onchange="toggleOtherText(this)"> Other</label>
                </div>
                <input type="text" class="action-other-text" placeholder="Please specify other action taken..." style="display:none;">
            </div>

            <label class="remark-label">Remark for this drive:</label>
            <textarea class="remark-input" rows="3" placeholder="Enter remarks"></textarea>
        </div>

        <div class="drive-section">
            <label for="crew_ids_spad">RAILWAY BOARD SAFETY DRIVE COUNSELLING ON SPAD</label>
            <input type="text" id="crew_ids_spad" class="crew-input" data-drive-name="RAILWAY BOARD SAFETY DRIVE COUNSELLING ON SPAD" placeholder="Enter Crew IDs, separated by comma..." oninput="formatCrewIDs(this)">
            <p class="char-limit-message"></p>
            
            <label class="location-label">Counselling Done at:</label>
            <select class="location-select">
                <option value="">Select Location</option>
                <option value="LOBBY">LOBBY</option>
                <option value="FOOTPLATE">FOOTPLATE</option>
            </select>

            <label class="abnormality-label">Abnormalities Found on this drive:</label>
            <input type="text" class="abnormality-input" value="NIL" oninput="checkAbnormalities(this)">

            <div class="action-taken-container">
                <label style="margin-top:0;">Action Taken:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" class="action-cms"> Reported in CMS</label>
                    <label><input type="checkbox" class="action-other" onchange="toggleOtherText(this)"> Other</label>
                </div>
                <input type="text" class="action-other-text" placeholder="Please specify other action taken..." style="display:none;">
            </div>

            <label class="remark-label">Remark for this drive:</label>
            <textarea class="remark-input" rows="3" placeholder="Enter remarks"></textarea>
        </div>

        <div class="drive-section">
            <label for="crew_ids_winter">WINTER AND FOG PRECAUTION SAFETY DRIVE</label>
            <input type="text" id="crew_ids_winter" class="crew-input" data-drive-name="WINTER AND FOG PRECAUTION SAFETY DRIVE" placeholder="Enter Crew IDs, separated by comma..." oninput="formatCrewIDs(this)">
            <p class="char-limit-message"></p>
                
            <label class="location-label">Counselling Done at:</label>
            <select class="location-select">
                <option value="">Select Location</option>
                <option value="LOBBY">LOBBY</option>
                <option value="FOOTPLATE">FOOTPLATE</option>
            </select>

            <label class="abnormality-label">Abnormalities Found on this drive:</label>
            <input type="text" class="abnormality-input" value="NIL" oninput="checkAbnormalities(this)">

            <div class="action-taken-container">
                <label style="margin-top:0;">Action Taken:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" class="action-cms"> Reported in CMS</label>
                    <label><input type="checkbox" class="action-other" onchange="toggleOtherText(this)"> Other</label>
                </div>
                <input type="text" class="action-other-text" placeholder="Please specify other action taken..." style="display:none;">
            </div>

            <label class="remark-label">Remark for this drive:</label>
            <textarea class="remark-input" rows="3" placeholder="Enter remarks"></textarea>
        </div>

        <div class="drive-section">
            <label for="crew_ids_rs_valve">Practical RS Application during Footplate</label>
            <input type="text" id="crew_ids_rs_valve" class="crew-input" data-drive-name="Practical RS Application during Footplate" placeholder="Enter Crew IDs, separated by comma..." oninput="formatCrewIDs(this)">
            <p class="char-limit-message"></p>
            
            <label class="location-label">Practical RS Application done at :</label>
            <input type="text" class="location-input" placeholder="Enter Location">

            </div>
        <br>
        <label>ONGOING SAFETY DRIVE:</label>
        <div class="ongoing-drive-table">
            <div class="table-header">
                <div>Drive / Google Link</div>
                <div>Download PDF</div>
            </div>
            <div class="table-cell">
                <a href="https://docs.google.com/spreadsheets/d/1AzJEp0--ScREpzMMvUT9lO3RkdhUoyvJT2BZWAG_WgA/edit?gid=0#gid=0" target="_blank" class="drive-link-button">(RS PRACTICE ON RUN DETAILS)</a>
            </div>
            <div class="table-cell">
                <a href="https://docs.google.com/spreadsheets/d/1IqgKKpbLgGdkmC6eXgvtUFCxhLkIU0kgyVBgt0zadnM/edit?gid=0#gid=0" target="_blank" class="drive-link-button">(RS PRACTICE DATE ENTRY FOR ALPS )</a>
            </div>
             <br><br>

        <button type="submit">SUBMIT</button>
    </form>

<script>
    let cliData = {};
    let crewData = {};
    let isSubmitting = false;

    // === NEW FUNCTIONS FOR ABNORMALITIES & ACTION TAKEN ===
    
    function checkAbnormalities(inputElement) {
        const driveSection = inputElement.closest('.drive-section');
        const actionContainer = driveSection.querySelector('.action-taken-container');
        
        // Safety check if element exists (since some sections don't have it)
        if (!actionContainer) return;

        // If value is NOT "NIL" (case insensitive), show action section
        if (inputElement.value.trim().toUpperCase() !== 'NIL') {
            actionContainer.style.display = 'block';
        } else {
            actionContainer.style.display = 'none';
            // Reset fields if hidden
            driveSection.querySelector('.action-cms').checked = false;
            driveSection.querySelector('.action-other').checked = false;
            driveSection.querySelector('.action-other-text').style.display = 'none';
            driveSection.querySelector('.action-other-text').value = '';
        }
    }

    function toggleOtherText(checkbox) {
        const driveSection = checkbox.closest('.drive-section');
        const otherTextInput = driveSection.querySelector('.action-other-text');
        if (checkbox.checked) {
            otherTextInput.style.display = 'block';
        } else {
            otherTextInput.style.display = 'none';
            otherTextInput.value = '';
        }
    }

    // === EXISTING FUNCTIONS ===

    function formatCLIID() {
        let input = document.getElementById("cli_id");
        input.value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        fetchCLIData();
    }
    
    function formatCrewIDs(inputElement) {
        const messageElement = inputElement.nextElementSibling;
        let value = inputElement.value.toUpperCase().replace(/[^A-Z0-9,]/g, '');
        let ids = value.split(',');
        let lastIdSegment = ids[ids.length - 1];
        let message = '';

        if (lastIdSegment.length > 8) {
            message = 'Please Enter Comma.';
            lastIdSegment = lastIdSegment.substring(0, 8);
            ids[ids.length - 1] = lastIdSegment;
            value = ids.join(',');

        } else {
            const letterCount = (lastIdSegment.match(/[A-Z]/g) || []).length;
            const numberCount = (lastIdSegment.match(/[0-9]/g) || []).length;

            if (letterCount > 4 || numberCount > 4) {
                message = 'Invalid combination (max 4 letters/numbers).';
                lastIdSegment = lastIdSegment.slice(0, -1);
                ids[ids.length - 1] = lastIdSegment;
                value = ids.join(',');
            }
        }

        if (messageElement) {
            messageElement.textContent = message;
        }
        inputElement.value = value;
    }

    function loadCLIData() {
        fetch('CLIMICRO.csv')
            .then(response => response.text())
            .then(data => { Papa.parse(data, { header: true, skipEmptyLines: true, complete: r => { r.data.forEach(row => cliData[row["LI ID"]] = { name: row["NAME"], hq: row["HQ"] }); }}); });
    }

    function loadCrewData() {
        fetch('CREWM.csv')
            .then(response => response.text())
            .then(data => { Papa.parse(data, { header: true, skipEmptyLines: true, complete: r => { r.data.forEach(row => crewData[row["CREW ID"]] = { name: row["CREW NAME"], desg: row["DESG"], hq: row["HQ"] }); }}); });
    }

    function fetchCLIData() {
        let cliID = document.getElementById("cli_id").value;
        document.getElementById("cli_name").value = cliData[cliID] ? cliData[cliID].name : "";
        document.getElementById("cli_hq").value = cliData[cliID] ? cliData[cliID].hq : "";
    }

    document.getElementById("safetyDriveForm").addEventListener("submit", function(event) {
        event.preventDefault();
        if (isSubmitting) {
            alert("Form already submitted, please wait...");
            return;
        }

        let crewInputs = document.querySelectorAll('.crew-input');
        let totalCrewEntered = 0;
        let validationError = false;

        crewInputs.forEach(input => {
            if (validationError) return;

            const crewIDsString = input.value.trim();
            if (crewIDsString !== "") {
                totalCrewEntered++;
                const driveSection = input.closest('.drive-section');
                const driveLabel = driveSection.querySelector('label').innerText;
                
                // === UPDATED LOCATION CHECK (Supports Select or Input) ===
                const locationElement = driveSection.querySelector('.location-select') || driveSection.querySelector('.location-input');
                
                if (!locationElement || locationElement.value.trim() === "") {
                    validationError = true;
                    alert(`Please enter/select a location for the drive: "${driveLabel}"`);
                    return;
                }

                const crewIDs = crewIDsString.split(',').map(id => id.trim()).filter(id => id !== "");
                for (const id of crewIDs) {
                    const hasLetter = /[A-Z]/.test(id);
                    const hasNumber = /[0-9]/.test(id);
                    const letterCount = (id.match(/[A-Z]/g) || []).length;
                    const numberCount = (id.match(/[0-9]/g) || []).length;

                    if (id.length > 8 || !hasLetter || !hasNumber || letterCount > 4 || numberCount > 4) {
                        validationError = true;
                        alert(`Invalid Crew ID "${id}" in drive "${driveLabel}".\n\n- Max 8 characters.\n- Must be a mix of letters and numbers (max 4 of each).`);
                        return;
                    }
                }
            }
        });

        if (validationError) return;
        if (totalCrewEntered === 0) {
            alert("Please enter at least one Crew ID in any of the drive sections.");
            return;
        }
        
        isSubmitting = true;
        let submitButton = document.querySelector("button[type='submit']");
        submitButton.disabled = true;
        submitButton.innerText = "Submitting...";
        submitButton.style.backgroundColor = "#FF8C00";

        let commonFormData = new FormData(this);
        let submissionPromises = [];
        
        crewInputs.forEach(inputField => {
            let driveName = inputField.dataset.driveName;
            let crewIDsString = inputField.value.trim();
            if (crewIDsString === "") return;

            const driveSection = inputField.closest('.drive-section');
            
            // === UPDATED DATA RETRIEVAL (Safely handles missing fields) ===
            const locationElement = driveSection.querySelector('.location-select') || driveSection.querySelector('.location-input');
            const locationValue = locationElement ? locationElement.value : "";

            const remarkElement = driveSection.querySelector('.remark-input');
            const remarkValue = remarkElement ? remarkElement.value : "";
            
            const abnElement = driveSection.querySelector('.abnormality-input');
            const abnormalitiesValue = abnElement ? abnElement.value : "NIL"; // Default to NIL if missing

            let actionTakenString = "";

            if (abnormalitiesValue.trim().toUpperCase() !== 'NIL' && abnormalitiesValue !== "NIL") {
                let actions = [];
                // Check if elements exist before accessing 'checked' property
                let cmsCb = driveSection.querySelector('.action-cms');
                if (cmsCb && cmsCb.checked) actions.push("Reported in CMS");
                
                let otherCb = driveSection.querySelector('.action-other');
                if (otherCb && otherCb.checked) {
                    let otherText = driveSection.querySelector('.action-other-text').value;
                    actions.push("Other: " + otherText);
                }
                actionTakenString = actions.join(', ');
            }
            // =============================================

            let crewIDs = crewIDsString.split(',').filter(id => id.trim() !== "");

            crewIDs.forEach(crewID => {
                crewID = crewID.trim();
                if (!crewID) return;
                let jsonData = {};
                
                jsonData['date'] = commonFormData.get('date');
                jsonData['cli_id'] = commonFormData.get('cli_id');
                jsonData['cli_name'] = commonFormData.get('cli_name');
                jsonData['cli_hq'] = commonFormData.get('cli_hq');
                jsonData["drive_name"] = driveName;
                jsonData["counselling_location"] = locationValue;
                jsonData["remark"] = remarkValue;
                
                // Add new fields to JSON
                jsonData["abnormalities"] = abnormalitiesValue;
                jsonData["action_taken"] = actionTakenString;

                jsonData["crew_id"] = crewID;
                jsonData["crew_name"] = crewData[crewID] ? crewData[crewID].name : "Not Found";
                jsonData["desg"] = crewData[crewID] ? crewData[crewID].desg : "N/A";
                jsonData["hq"] = crewData[crewID] ? crewData[crewID].hq : "N/A";
                jsonData["timestamp"] = new Date().toISOString();

                let promise = fetch("https://script.google.com/macros/s/AKfycbz7VLDi96OQTKCbrveBmauU3mTJSFYyydtlx67qFoO0dPUwI5KU-60HaJGoHwmKlhx-kw/exec", {
                    method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(jsonData)
                });
                submissionPromises.push(promise);
            });
        });

        Promise.all(submissionPromises).then(() => {
             setTimeout(() => {
                 alert("Data Successfully Submitted!");
                 document.getElementById("safetyDriveForm").reset();
                 
                 // Reset UI for new fields (safely)
                 document.querySelectorAll('.action-taken-container').forEach(el => el.style.display = 'none');
                 document.querySelectorAll('.action-other-text').forEach(el => el.style.display = 'none');
                 document.querySelectorAll('.abnormality-input').forEach(el => el.value = 'NIL');
                 
                 document.querySelectorAll('.char-limit-message').forEach(el => el.textContent = '');
                 isSubmitting = false;
                 submitButton.disabled = false;
                 submitButton.innerText = "Submit";
                 submitButton.style.backgroundColor = "#007BFF";
             }, 500);
        });
    });

    window.onload = function() {
        loadCLIData();
        loadCrewData();
        document.getElementById('date').valueAsDate = new Date();
    };
</script>
</body>
</html>



