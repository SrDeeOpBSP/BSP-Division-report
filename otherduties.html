<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Other Duties Form</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        #otherDutiesForm { background: #fff; width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 5px solid #007bff; }
        h2 { text-align: center; color: #333; margin-bottom: 25px; text-transform: uppercase; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        input, select { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        input[readonly] { background-color: #e9ecef; font-weight: 600; }
        #otherDutyGroup { background: #f9f9f9; padding: 15px; border: 1px dashed #007bff; border-radius: 8px; margin-bottom: 20px; display: none; }
        #submitButton { width: 100%; padding: 14px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; text-transform: uppercase; }
        #submitButton:disabled { background-color: #ccc; }
        #msg { text-align: center; margin-top: 15px; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <form id="otherDutiesForm">
        <h2>OTHER DUTIES</h2>
        
        <label>CLI ID</label>
        <input type="text" id="CLI_ID" name="CLI ID" placeholder="e.g., BSP0123" maxlength="8" required>

        <label>CLI NAME</label>
        <input type="text" id="CLI_NAME" name="CLI NAME" readonly required>

        <label>CLI LOBBY</label>
        <input type="text" id="CLI_HQ" name="CLI LOBBY" readonly required>

        <label>DUTY TYPE</label>
        <select id="dutyType" name="DUTY TYPE" required onchange="toggleFields()">
            <option value="" disabled selected>Select DUTY TYPE</option>
            <option value="LOBBY DUTY">LOBBY DUTY</option>
            <option value="STALLING DUTY">STALLING DUTY</option>
            <option value="PUNCTUALITY DUTY">PUNCTUALITY DUTY</option>
            <option value="AUTO CLASS">AUTO CLASS</option>
            <option value="REST">REST</option>
            <option value="SICK/RMC/PMC">SICK/RMC/PMC</option>
            <option value="LEAVE">LEAVE</option>
            <option value="TRAINING">TRAINING</option>
            <option value="OTHER DUTY">OTHER DUTY</option>
        </select>

        <div id="otherDutyGroup">
            <label>OTHER DUTY DONE</label>
            <select id="subType">
                <option value="AS PER TLC">AS PER TLC</option>
                <option value="SELF PROGRAMMED">SELF PROGRAMMED</option>
            </select>

            <label>ENTER DESCRIPTION</label>
            <input type="text" id="descRaw" placeholder="Description yahan likhen...">
        </div>

        <label>DATE</label>
        <input type="date" id="date" name="DATE" required>

        <label>FROM TIME</label>
        <input type="time" id="fromTime" name="FROM TIME" required>

        <label>TO TIME</label>
        <input type="time" id="toTime" name="TO TIME" required>

        <button type="submit" id="submitButton">Submit Data</button>
        <div id="msg">Submitting...</div>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let cliMap = {};
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzD319B272QFM5HK-3ejkl41n3zm1r_0F6bc9ZzJE1Z_6Tc-4wge65Ip16uQe9eDUmrUw/exec';

        $(document).ready(function() {
            fetch('CLIMICRO.csv').then(res => res.text()).then(data => {
                data.split('\n').slice(1).forEach(line => {
                    const p = line.split(',');
                    if(p.length >= 3) cliMap[p[0].trim().toUpperCase()] = { n: p[1], h: p[2] };
                });
            });
            document.getElementById('date').valueAsDate = new Date();
        });

        function toggleFields() {
            const isOther = document.getElementById('dutyType').value === "OTHER DUTY";
            document.getElementById('otherDutyGroup').style.display = isOther ? 'block' : 'none';
        }

        document.getElementById('CLI_ID').addEventListener('input', function(e) {
            let id = e.target.value.toUpperCase();
            if(cliMap[id]) {
                document.getElementById('CLI_NAME').value = cliMap[id].n;
                document.getElementById('CLI_HQ').value = cliMap[id].h;
            }
        });

        const form = document.getElementById('otherDutiesForm');
        form.addEventListener('submit', e => {
            e.preventDefault();
            
            const btn = document.getElementById('submitButton');
            const msg = document.getElementById('msg');
            const dutyDropdown = document.getElementById('dutyType');
            
            // Backup original value in case we need to reset
            const originalValue = dutyDropdown.value;

            // AGAR OTHER DUTY HAI: toh dropdown ki value ko description se replace kar rahe hain
            if(originalValue === "OTHER DUTY") {
                const desc = document.getElementById('descRaw').value;
                const type = document.getElementById('subType').value;
                
                // Naya option create karke select kar rahe hain taki Form Data mein yahi jaye
                const newFormattedValue = `${desc} (${type})`;
                
                // Temp option create karke dropdown mein set kar rahe hain submit ke liye
                const tempOpt = document.createElement('option');
                tempOpt.value = newFormattedValue;
                tempOpt.text = newFormattedValue;
                dutyDropdown.add(tempOpt);
                dutyDropdown.value = newFormattedValue;
            }

            btn.disabled = true;
            msg.style.display = "block";
            msg.innerText = "Saving Data...";

            fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                .then(res => {
                    msg.innerText = "✅ Success! Form Resetting...";
                    msg.style.color = "green";
                    setTimeout(() => {
                        location.reload(); // Page reload sabse best reset hai
                    }, 2000);
                })
                .catch(err => {
                    msg.innerText = "❌ Error! Check Connection.";
                    btn.disabled = false;
                });
        });
    </script>
</body>
</html>

